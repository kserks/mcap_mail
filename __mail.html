<!doctype html>
<html>
<head>
<meta charset="utf-8" />
<title>Почта</title>
<script src="https://zimjs.org/cdn/1.3.2/createjs.js"></script>
<script src="https://zimjs.org/cdn/cat/03/zim.js"></script>
<style>
  #frame {position:absolute; left:15px; top:15px;  width:1024px; height:510px; font-family:Minecraft; font-size:16px;}
</style>
<script>

  const server = "http://atlant.mcacademy.ru";
  const api_ri = "/reindexer/api/v1/db/";
  const url_transactions = server+api_ri+'mcap_bank/namespaces/transactions/items'
  const url_balances = server+api_ri+'mcap_bank/namespaces/balances/items';
  let curPlayer = null;
  let gui = [];
  let player_name = 'mcap_happy'
  
  function createUUID() {
    var s = []; var hexDigits = "0113456789abcdef";
    for (var i = 0; i < 36; i++) {
        s[i] = hexDigits.substr(Math.floor(Math.random() * 0x10), 1);
    }; s[14] = "4"; s[19] = hexDigits.substr((s[19] & 0x3) | 0x8, 1);
    s[8] = s[13] = s[18] = s[23] = "-"; var uuid = s.join(""); return uuid;
  }

  function rPost(db, ns, array) {
      var xhr = new XMLHttpRequest(); xhr.open("POST", server+api_ri+db+'/namespaces/'+ns+'/items', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send(JSON.stringify(array)); return xhr.status;
  }

  function rPut(db, ns, array) {
      var xhr = new XMLHttpRequest(); xhr.open("PUT", server+api_ri+db+'/namespaces/'+ns+'/items', true);
      xhr.setRequestHeader('Content-Type', 'application/x-www-form-urlencoded');
      xhr.send(JSON.stringify(array)); return xhr.status;
  }

  function rQuery(query, db) {
    var xhr = new XMLHttpRequest();
    let q = api_ri;
    if (db == null) {q += 'mcap_mail';} 
    else {q += db;}
    xhr.open('GET', q+'/query?q=' + encodeURIComponent(query), false);
    xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
    xhr.send(); return JSON.parse(xhr.response).items;
  }

  function query(url) {
    var xhr = new XMLHttpRequest();
    zog(url)
    xhr.open('GET', url, false);
    xhr.setRequestHeader('Content-type', 'application/json; charset=utf-8');
    xhr.send(); //return JSON.parse(xhr.response);
  }

  function getDate() {
    var t = new Date(); var d = t.getDate(); var m = t.getMonth()+1;
    if (d < 10) {d = '0' + d}; if (m < 10) {m = '0' + m}; 
    return d+'.'+m+'.'+t.getFullYear();
  }

  function getTSO() {
    return Math.trunc(new Date().getTime() / 1000);
  }

  function getTS() {
    let t = new Date(); let h = t.getHours(); 
    let m = t.getMinutes(); let s = t.getSeconds();
    if (h < 10) {h = '0'+h}; 
    if (m < 10) {m = '0'+m};
    if (s < 10) {s = '0'+s}; 
    return getDate()+'-'+h+':'+m+':'+s;
  }

  // Заморозка/Разморозка счёта
  function freezeAccount (id, isClose) {
    rQuery('update accounts set close = '+isClose+' where id="'+id+'"');
  }

  // Заморозка/Разморозка транзакции
  function freezeTransaction (id, isClose) {
    rQuery('update transactions set cancel = '+isClose+' where id="'+id+'"');
  }

  let window_player_name
  function getPlayer() {
    try {
      window.mcefQuery({
        "request":"info","persistent":true,
        "onSuccess":function(response) {
          window_player_name=JSON.parse(response).name;
        }
      });
    } catch (errorCode) {window_player_name='mcap_happy';}
  }
  getPlayer();

  function onButtonClick(btn, fun) {
    if (fun()) {
      gui[btn].backgroundColor = 'green';
      setTimeout(() => {
        gui[btn].backgroundColor = '#1a374a';
      }, 200);
    }
    else {
      gui[btn].backgroundColor = 'red';
      setTimeout(() => {
        gui[btn].backgroundColor = '#1a374a';
      }, 200);
    };
  }

  // http://atlant.mcacademy.ru/gui/mail.html
  let assets = {assets:[{font:"Minecraft", src:"Minecraft.ttf"}], path:"assets/"};
  const frame = new Frame({scaling:'full',color:'#002137',width:1024,height:728, assets:assets});
  frame.on("ready", ()=> {
    
    STYLE = {size:20, corner:0, font:"Minecraft", Button:{height:40}, TextArea:{height:40, padding:6}};  
    const stage = frame.stage;
    let screen = new Container().addTo(stage);
    let mail_out_container, mail_in_container;
    let tarif = 1, mail_out, main_in;
    let mail_out_btns, mail_in_btns;

    function main() {
      screen.disposeAllChildren();
      stage.update();

      new Label({text:'Отправленные:',color:'#FFFFFF'})
        .pos(30,25).addTo(screen);

      gui.mail_out_bg = new Rectangle(400,300,"#003153").addTo(screen).pos(10,35);
      mail_out_container = new Container().addTo(screen).pos(10,35);
      mail_out_container.setMask(gui.mail_out_bg);

      new Label({text:'Получатель:',color:'#FFFFFF'})
        .pos(435,25).addTo(screen);

      new Label({text:'Тема:',color:'#FFFFFF'})
        .pos(695,25).addTo(screen);

      new Label({text:'Тариф:',color:'#FFFFFF'})
        .pos(1085,25).addTo(screen);

      gui.target = new TextArea({width:250, color:white})
        .pos(430,60).addTo(screen);

      gui.subject = new TextArea({width:380, color:white})
        .pos(690,60).addTo(screen);

      gui.tarif = new TextArea({width:160, color:white,reedOnly:true})
        .pos(1080,60).addTo(screen);

      gui.tarif.text = tarif;

      new Label({text:'Слот:',color:'#FFFFFF'})
        .pos(1085,125).addTo(screen);

      gui.slot_out = new TextArea({width:160, color:white})
        .pos(1080,160).addTo(screen);

      gui.slot_out.on("input",()=>{onSlotInput();});
      
      new Label({text:'Стоимость:',color:'#FFFFFF'})
        .pos(1085,225).addTo(screen);

      gui.price_out = new TextArea({width:160, color:white})
        .pos(1080,260).addTo(screen);

      gui.btn_send = new Button({
        label:new Label({text:'Отправить',color:'green'}),
        width:160,backgroundColor:"#1a374a",
        borderWidth:8,rollBackgroundColor:"#08457e",
        borderColor:white,borderWidth:2,corner:0,
        borderRollColor:white
      }).pos(1080,317).addTo(screen);

      gui.btn_send.on("click",()=>{
        onButtonClick('btn_send', onSendClick);
      });

      gui.body_out = new TextArea({width:640, height:250, color:white})
        .pos(430,110).addTo(screen);

      new Label({text:'Полученные:',color:'#FFFFFF'})
        .pos(30,385).addTo(screen);

      gui.mail_in = new Rectangle(400,300,"#003153").addTo(screen).pos(10,395);
      mail_in_container = new Container().addTo(screen).pos(10,395);
      mail_in_container.setMask(gui.mail_in);

      new Label({text:'Содержание почтового отправления:',color:'#FFFFFF'})
        .pos(435,385).addTo(screen);

      new Label({text:'Слот:',color:'#FFFFFF'})
        .pos(1085,435).addTo(screen);

      gui.slot_in = new TextArea({width:160, color:white})
        .pos(1080,470).addTo(screen);
      
      new Label({text:'Стоимость:',color:'#FFFFFF'})
        .pos(1085,535).addTo(screen);

      gui.price_in = new TextArea({width:160, color:white})
        .pos(1080,570).addTo(screen);

      gui.btn_get = new Button({
        label:new Label({text:'Получить',color:'green'}),
        width:160,backgroundColor:"#1a374a",
        borderWidth:8,rollBackgroundColor:"#08457e",
        borderColor:white,borderWidth:2,corner:0,
        borderRollColor:white
      }).pos(1080,627).addTo(screen);
      
      gui.btn_get.on("click",()=>{
        onButtonClick('btn_get', onGetClick);
      });

      gui.btn_delete = new Button({
        label:new Label({text:'Удалить',color:'red'}),
        width:160,backgroundColor:"#1a374a",
        borderWidth:8,rollBackgroundColor:"#08457e",
        borderColor:white,borderWidth:2,corner:0,
        borderRollColor:white
      }).pos(1080,678).addTo(screen);

      gui.btn_delete.on("click",()=>{
        onButtonClick('btn_delete', onDeleteClick);
      });

      gui.body_in = new TextArea({width:640, height:300, color:white})
        .pos(430,420).addTo(screen);

      updateMailOut();
      updateMailIn();
    }

    main()

    function updateMailOut() {
      mail_out_container.disposeAllChildren();
      mail_out = rQuery('select * from items where sender="'+window_player_name+'" '+
        'join (select * from status) on items.id = status.item '+
        'join (select * from storage) on items.id = storage.item', 'mcap_mail'
      )

      let mail_temp = [];
      for (let i=0; i<mail_out.length; i++) {
        let m = mail_out[i];
        let s = m.joined_status;
        if (typeof(s) != 'undefined' && !s[0].delete) {
          mail_temp.push(m);
        }
      }
      mail_out = mail_temp;

      mail_out_btns = [];
      for (let i=0; i<mail_out.length; i++) {
        let m = mail_out[i];
        let text = m.target + ' - ' + m.subject;
        mail_out_btns[i] = new Button({
          label:new Label({text:text,color:'#FFFFFF'}),
          width:360,height:40,backgroundColor:"#1a374a",
          rollBackgroundColor:"#08457e",align:LEFT
        }).addTo(mail_out_container).pos(0, i*41);
        mail_out_btns[i].name = i;
        mail_out_btns[i].on("click", (self)=>{onMailOutClick(self.currentTarget.name)});
      }
      if (typeof(gui.slider_out) != 'undefined') {
        gui.slider_out.dispose();
      }
      gui.slider_out = new Slider({
        button:new Button({width:40,height:40,label:"",color:pink}).expand(),
        barColor:grey,vertical:true,keyArrows:false,inside:true,currentValue:0,
        min: (5 + mail_out_btns.length*40) - 300 ,max:0,step:0,barLength:300,barWidth:40
      }).addTo(screen).pos(360,35);
      gui.slider_out.on("change", ()=> {
        if (mail_out_btns.length*40>300) {
          mail_out_container.y = gui.slider_out.y - gui.slider_out.currentValue;
        };
      });
      stage.update();
    }

    function updateMailIn() {
      mail_in_container.disposeAllChildren();
      mail_in = rQuery('select * from items where target="'+window_player_name+'" '+
        'join (select * from status) on items.id = status.item '+
        'join (select * from storage) on items.id = storage.item', 'mcap_mail'
      )

      let mail_temp = [];
      for (let i=0; i<mail_in.length; i++) {
        let m = mail_in[i];
        let s = m.joined_status;
        if (typeof(s) != 'undefined' && !s[0].delete) {
          mail_temp.push(m);
        }
      }
      mail_in = mail_temp;

      mail_in_btns = [];
      for (let i=0; i<mail_in.length; i++) {
        let m = mail_in[i];
        let s = m.joined_status;
        let text = m.target + ' - ' + m.subject;
        mail_in_btns[i] = new Button({
          label:new Label({text:text,color:'#FFFFFF'}),
          width:360,height:40,backgroundColor:"#1a374a",
          rollBackgroundColor:"#08457e",align:LEFT
        }).addTo(mail_in_container).pos(0, i*41);
        mail_in_btns[i].name = i;
        mail_in_btns[i].on("click", (self)=>{onMailInClick(self.currentTarget.name)});
      }
      if (typeof(gui.slider_in) != 'undefined') {
        gui.slider_in.dispose();
      }
      gui.slider_in = new Slider({
        button:new Button({width:40,height:40,label:"",color:pink}).expand(),
        barColor:grey,vertical:true,keyArrows:false,inside:true,currentValue:0,
        min: (5 + mail_out_btns.length*40) - 300 ,max:0,step:0,barLength:300,barWidth:40
      }).addTo(screen).pos(360,395);
      gui.slider_in.on("change", ()=> {
        if (mail_out_btns.length*40>300) {
          mail_in_container.y = gui.slider_in.y - gui.slider_in.currentValue;
        };
      });
      stage.update();
    }

    function transaction(payer, target, sum) {
      let payer_bank = rQuery('select id from accounts where player="'+payer+'" and main=true', 'mcap_bank');
      let target_bank = rQuery('select id from accounts where player="'+target+'" and main=true', 'mcap_bank');
      if (payer_bank.length == 1 && target_bank.length == 1) {
        payer_bank = payer_bank[0].id; target_bank = target_bank[0].id;
        let t = new Date(); let ts = getTS(); let tso = getTSO(); 
        let id1 = createUUID(); let id2 = createUUID();
        let res1 = rPost('mcap_bank', 'transactions', {
          id:id1, ts:ts, tsy:t.getFullYear(), tsm:t.getMonth(),
          tsd:t.getDate(), type:'mail', acc:payer_bank[0].id, 
          dt:0, kt:sum, cancel:false, descr:'', kor:id2, tso:tso
        });
        let res2 = rPost('mcap_bank', 'transactions', {
          id:id2, ts:ts, tsy:t.getFullYear(), tsm:t.getMonth(),
          tsd:t.getDate(), type:'mail', acc:target_bank[0].id,
          dt:sum, kt:0, cancel:false, descr:'', kor:id1, tso:tso
        });
        if (res1 == 0 && res2 == 0) {
          return true;
        }
      }; return false;
    }

    function onSendClick() {
      let target = gui.target.text;
      let subject = gui.subject.text;
      let slot = Number(gui.slot_out.text);
      let price = Number(gui.price_out.text);
      let body = gui.body_out.text;
      let recipient_data = rQuery('select name from players where name="'+target+'"','mcap_main');
      let payer, res1, res2, res3;
      if (recipient_data.length == 1) {
        if (price == 0) { 
          payer = window_player_name; 
        } else { payer = target; };
        if (transaction(window_player_name, 'mcap_happy', tarif)) {
          let item_id = createUUID();
          res1 = rPost('mcap_mail', 'items', {
            id:item_id, sender:window_player_name, target:target,
            subject:subject, body:body, price:price, 
            payer:payer, tso:getTSO()
          });
          res2 = rPost('mcap_mail', 'status', {
            item:item_id, mail:false, storage:false,
            delete:false, paid:false
          });
          if (slot != 0) { 
            let storage = rQuery('select pos from storage where item=""');
            if (storage.length > 0) {
              let pos = storage[0].pos; slot -= 1;
              let transaction_id = createUUID();
              res3 = rPost('mcap_mail', 'transactions', {
                id:transaction_id, player:window_player_name, slot:slot,
                type:'send', pos:pos, client:true, server:false
              });
              rQuery('update storage set item="'+item_id+'" where pos="'+pos+'"');
              zog(1)
              setTimeout(() => {
                zog(123)
                query(server+'/rcon/?player='+window_player_name+'&src=post&cmd=send&id='+transaction_id);
              }, 50);
            }
          } else {
            res3 = 0;
          }
        }
      }
      if (res1==0 && res2==0 && res3==0) {
        updateMailOut();
        updateMailIn();
        return true;
      } else {
        return false;
      }
    }

    function onGetClick() {
      let slot = Number(gui.slot_in.text);
      if (slot > 0 && slot < 10 && cur_mail_in != null) {
        let s = mail_in[cur_mail_in].joined_status[0];
        let m = mail_in[cur_mail_in];
        if (!s.paid && m.payer == m.target && m.price != 0 && transaction(m.target,m.sender,m.price)) {
          rQuery('update status set paid=true where item="'+m.id+'"');
          s.paid = true;
        }
        let storage = rQuery('select pos from storage where item="'+m.id+'"')
        if (!s.storage && storage.length == 1) {
          let pos = storage[0].pos;
          let transaction_id = createUUID();
          res3 = rPost('mcap_mail', 'transactions', {
            id:transaction_id, player:window_player_name, slot:slot-1,
            type:'receive', pos:pos, client:true, server:false
          });
          
          setTimeout(() => {
            query(server+'/rcon/?player='+window_player_name+'&src=post&cmd=receive&id='+transaction_id);
          }, 50);
          if (true) {
            rQuery('update storage set item="" where pos="'+storage[0].pos+'"');
            rQuery('update status set storage=true where item="'+m.id+'"');
            s.storage = true; return true;
          }
        }
      }; return false;
    }

    let cur_mail_out = null;
    function onMailOutClick(i) {
      
      if (cur_mail_out == null) {
        mail_out_btns[i].backgroundColor = 'green';
        cur_mail_out = i;
      } else if (cur_mail_out == i) {
        mail_out_btns[i].backgroundColor = '#1a374a';
        cur_mail_out = null;
      } else {
        mail_out_btns[cur_mail_out].backgroundColor = '#1a374a';
        mail_out_btns[i].backgroundColor = 'green';
        cur_mail_out = i;
      }

      if (cur_mail_out != null) {
        let m = mail_out[i];
        gui.target.text = m.target;
        gui.subject.text = m.subject;
        gui.body_out.text = m.body;
        gui.price_out.text = m.price;
      } else {
        gui.target.text = '';
        gui.subject.text = '';
        gui.body_out.text = '';
        gui.price_out.text = '';
      }

    }

    let cur_mail_in = null;
    function onMailInClick(i) {
      
      if (cur_mail_in == null) {
        mail_in_btns[i].backgroundColor = 'green';
        cur_mail_in = i;
      } else if (cur_mail_in == i) {
        mail_in_btns[i].backgroundColor = '#1a374a';
        cur_mail_in = null;
      } else {
        if (typeof(mail_in_btns[cur_mail_in]) != 'undefined') {
          mail_in_btns[cur_mail_in].backgroundColor = '#1a374a';
        }
        mail_in_btns[i].backgroundColor = 'green';
        cur_mail_in = i;
      }

      if (cur_mail_in != null) {
        let m = mail_out[i];
        gui.body_in.text = m.body;
        gui.price_in.text = m.price;
        if (!m.joined_status[0].mail) {
          rQuery('update status set mail='+true+' where item="'+m.id+'"');
          m.joined_status[0].mail = true;
        }
      } else {
        gui.body_in.text = '';
        gui.price_in.text = '';
      }

    }

    function onDeleteClick() {
      if (cur_mail_in != null) {
        let item = mail_in[cur_mail_in].id;
        rQuery('update status set delete='+true+' where item="'+item+'"');
        setTimeout(() => {
          updateMailIn();
          updateMailOut();
        }, 50);
      }
    }
    
    function onSlotInput() {
      let slot = Number(gui.slot_out.text);
      if (slot == 0) {
        tarif = 1;
        gui.tarif.text = '1';
      } else {
        tarif = 5;
        gui.tarif.text = '5';
      }
    }

    function fill_database() {
      // for (let x=636; x<639; x++) {
      //   for (let z=-579; z<639; z++) {
      //     for (let x=636; x<639; x++) {

      //     }
      //   }
      // }
      let x = 636;
      for (let y=69; y<72; y++) {
        for (let z=-579; z<-553; z++) {
          rPost('mcap_mail', 'storage', {
            pos:x+' '+y+' '+z, item:''
          });
        }
      }
    }

    // fill_database()

  })
</script>
</head>
<body>
</body>
</html>